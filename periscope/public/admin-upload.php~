<?php
$page_title = "Upload Files";
require_once("../lib/sessions.php");
require_once("header.php");
require_once("../lib/val.php");


if(!logged_in()) {
	$_SESSION["errors"] = "Please log in to view this page";
	redirect_to("login.php");
}


//POST Handling

if (isset($_POST["submit"])){

	if ( isset($_FILES["file"])) {

		//if there was an error uploading the file 
		if ($_FILES["file"]["error"] > 0) {
			echo "Return Code: " . $_FILES["file"]["error"] . "<br />";
		
		} else {
			//Print file details 
			echo "Upload: " . $_FILES["file"]["name"] . "<br />";
			echo "Type: " . $_FILES["file"]["type"] . "<br />";
			echo "Size: " . ($_FILES["file"]["size"] / 1024) . " Kb<br />";
			echo "Temp file: " . $_FILES["file"]["tmp_name"] . "<br />";

			//if file already exists 
			if (file_exists("upload/" . $_FILES["file"]["name"])) {
				echo $_FILES["file"]["name"] . " already exists. ";
			} else {
				//Store file in directory "upload" with the name of "uploaded_file.txt"
            $storagename = $_FILES["file"]["name"];
            move_uploaded_file($_FILES["file"]["tmp_name"], $upload_dir . $storagename);
            echo "Stored in: " . "uploads/" . $_FILES["file"]["name"] . "<br />";
            
            if($work_file = fopen($upload_dir . $storagename, "r")) {
					while($data = fgetcsv($work_file, 1000, ",")) {
						echo $data[0] . ", " . $data[1] . "<br>";					
					}         
            } else {
					echo "Couldn't work!";            
            }
            
			}
		}
	} else {
		echo "No file selected <br />";
 	}
}



?>
<script type="text/javascript">
	$(document).ready(function () {
		
	});
</script>
<div id="content-wrapper">

	<div id="content">
		<?php 
			echo errors() . "<br>";
			list_errors();
		?>

		
			<form id="upload-csv" enctype="multipart/form-data" method="post" action="admin-upload.php">
				<hr>
				<p>Uploaded files must be <b>.csv</b> files. They also must have the following columns:</p>
				
				<h3>For Units:</h3>
				<table>
					<th>U_ID</th>
					<th>Name</th>
					<th>GradeLevel_id</th>
					<th>Subject_id</th>	
					<th>StartDate</th>
					<tr>
						<td>INT</td>
						<td>VARCHAR(30)</td>	
						<td>INT(11)</td>
						<td>VARCHAR(30)</td>
						<td>YYYY-MM-DD</td>
						<td>YYYY-MM-DD</td>				
					</tr>			
				</table>
				
				<h3>For Assets:</h3>
				<table>
					<th>U_ID</th>
					<th>Text</th>
					<tr>
						<td>INT</td>
						<td>VARCHAR(255)</td>			
					</tr>			
				</table>
				<input id="file" type="file" name="file"></input>
				<input type="hidden" name="MAX_FILE_SIZE" value="25000" />
				<label for="file">Upload File</label><br>
				<input id="submit" type="submit" name="submit" value="Upload"></input>
			</form>
	
	</div>

</div>


<?php require_once("footer.php"); ?>